name: Create Release

on:
  # Trigger after Draw Keymaps workflow completes successfully on main branch
  workflow_run:
    workflows: ["Draw ZMK Keymaps"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    # Only create release if the draw-keymaps workflow succeeded (which only runs if build succeeded)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
      actions: read  # Needed to download artifacts from other workflows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag generation

      - name: Create release assets directory
        run: mkdir -p release-assets

      - name: Download firmware artifacts from build workflow
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build.yml
          branch: main
          path: firmware-artifacts
          # Get most recent successful run
          workflow_conclusion: success

      - name: Download keymap PDF from draw-keymaps workflow
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: draw-keymaps.yml
          branch: main
          name: keymap-drawer-pdf
          path: keymap-artifacts
          # Get most recent successful run
          workflow_conclusion: success

      - name: Generate release tag
        id: tag
        run: |
          # Generate tag based on date and commit count
          DATE=$(date +'%Y%m%d')
          COUNT=$(git rev-list --count HEAD)
          TAG="v${DATE}.${COUNT}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG"

      - name: Gather release assets
        run: |
          # Create firmware bundle directory
          mkdir -p firmware-bundle

          # Copy firmware files to bundle
          find firmware-artifacts -name "*.uf2" -exec cp {} firmware-bundle/ \;

          # Copy keymap PDF to bundle and release assets
          cp keymap-artifacts/*.pdf firmware-bundle/ || echo "No PDF found"
          cp keymap-artifacts/*.pdf release-assets/ || echo "No PDF found"

          # Create firmware bundle zip with tag suffix
          cd firmware-bundle
          zip -r ../release-assets/allium58-firmware-bundle-${{ steps.tag.outputs.tag }}.zip .
          cd ..

          # Copy keymap SVG (but NOT yaml)
          cp keymap-drawer/*.svg release-assets/ || echo "No SVG found"

          echo "Release assets:"
          ls -lh release-assets/

      # === ADD CUSTOM DOCUMENTATION FILES HERE ===
      # To include additional files in releases (like flashing instructions,
      # layer documentation, troubleshooting guides), add them here:
      #
      # Example:
      #   - name: Add custom documentation
      #     run: |
      #       cp docs/FLASHING.md release-assets/
      #       cp docs/LAYERS.md release-assets/
      #       cp docs/TROUBLESHOOTING.pdf release-assets/
      #       cp docs/images/* release-assets/
      #
      # Any files placed in release-assets/ will be automatically included
      # in the GitHub release created below.
      #
      # Common documentation to include:
      # - Flashing instructions (how to install firmware)
      # - Layer documentation (detailed explanation of each layer)
      # - Troubleshooting guide (common issues and solutions)
      # - Build instructions (how to modify and rebuild)
      # - Hardware assembly guide
      # - BOM (bill of materials)
      # === END CUSTOM FILES SECTION ===

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Allium58 Firmware Release

            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}

            ### Included Files:
            - `allium58-firmware-bundle-${{ steps.tag.outputs.tag }}.zip` - **Complete firmware package** containing:
              - Left keyboard half firmware
              - Right keyboard half firmware
              - Settings reset firmware
              - Keymap PDF reference
            - `lily58.pdf` - Keymap document (printable reference)
            - `lily58.svg` - Keymap visual diagram (scalable vector)

            ### Flashing Instructions:
            1. Download and extract `allium58-firmware-bundle-${{ steps.tag.outputs.tag }}.zip`
            2. Turn off both shields
            3. Connect the left shield to your computer and double tap the reset button to enter bootloader mode
            4. If you are only updating keymaps (no display or settings changes)
              a. Drag and drop the left `.uf2` file onto the mounted drive
              b. you will see an error about unmounting (it can be ignored)
              c. Unplug and restart both shields and it should Connect
              d. YOU ARE DONE! No need to repeat for the other half
            5. If you are updating display or settings as well
              a. Drag and drop the `settings_reset-nice_nano_v2-zmk.uf2` file onto the mounted drive
              b. you will see an error about unmounting (it can be ignored)
              c. Unplug left shield
            6. Connect the right shield to your computer and double tap the reset button to enter bootloader mode
              a. Drag and drop the `settings_reset-nice_nano_v2-zmk.uf2` file onto the mounted drive
              b. you will see an error about unmounting (it can be ignored)
              c. Unplug right shield
            7. Reconnect left shield to your computer and double tap the reset button to enter bootloader mode
              a. Drag and drop the left half `.uf2` file onto the mounted drive
              b. you will see an error about unmounting (it can be ignored)
              c. Unplug left shield
            8. Connect the right shield to your computer and double tap the reset button to enter bootloader mode
              a. Drag and drop the right half `.uf2` file onto the mounted drive
              b. you will see an error about unmounting (it can be ignored)
              c. Unplug right shield
            9. In bluetooth settings on your computer, forget the keyboard
            10. Restart both shields and repair them with your computer
            11. YOU ARE DONE!

            ### Changes:
            ${{ github.event.head_commit.message }}

            ---
            Auto-generated from commit ${{ github.sha }}
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
